= simple_form_for @organization, html: { class: "form" } do |f|
  = f.error_notification
  .tabbable
    %ul.nav.nav-tabs.nav-tabs-simple#edit_pubtabs
      %li.active
        = link_to "#", class: "green-border", data: { toggle: "tab", target: "#details" } do
          Details
      %li
        = link_to '#', class: "green-border", data: { toggle: "tab", target: "#profile" } do
          Profile
      %li
        = link_to '#', class: "green-border", data: { toggle: "tab", target: "#business_locations" } do
          Locations
      %li
        = link_to "#", class: "green-border", data: { toggle: "tab", target: "#images" } do
          Images
      %li
        = link_to "#", class: "green-border", data: { toggle: "tab", target: "#contacts" } do
          Contacts
      %li
        = link_to "#", class: "green-border", data: { toggle: "tab", target: "#locations" } do
          Promote Locations
      - if @organization.id
        %li
          = link_to "#", class: "green-border", data: { toggle: "tab", target: "#managers" } do
            Managers
        %li
          = link_to "#", class: "green-border", data: { toggle: "tab", target: "#issues" } do
            Issues
        %li
          = link_to "#", class: "green-border", data: { toggle: "tab", target: "#promotions" } do
            Promotions
    .tab-content
      .tab-pane.active.form-horizontal#details
        .row-fluid
          .span5
            = f.input :name, input_html: { class: "input-block-level" }
            = f.input :org_type, collection: Organization::ORG_TYPE_OPTIONS, label: "Organization Type"
            = f.input :pay_rate_in_cents, collection: Organization::BLOGGER_PAY_RATES.map { |r| ["#{r} cents per click", r] }.insert(0, ['Select a pay rate', nil]), label: 'Blogger pay rate', include_blank: false
            = f.input :pay_directly, input_html: { class: 'input-block-level' }
            = f.association :consumer_apps, input_html: { class: "chosen-select input-block-level" }
            = f.association :parent, collection: Organization.where.not(id: @organization.id), label: "Parent Organization (Syndication)",
              input_html: { class: "input-block-level chosen-select-single-deselect" }, include_blank: true
            = f.input :subscribe_url, input_html: { class: 'input-block-level' }
            = f.input :banner_ad_override
          .span7
            = f.input :website, input_html: { class: "input-block-level" }
            = f.input :notes, input_html: { class: "input-block-level", rows: 10 } 
            = f.input :can_publish_news, input_html: { class: 'input-block-level' }
            = f.input :can_publish_events, input_html: { class: 'input-block-level' }
            = f.input :can_publish_market, input_html: { class: 'input-block-level' }
            = f.input :can_publish_talk, input_html: { class: 'input-block-level' }
            = f.input :can_publish_ads, input_html: { class: 'input-block-level' }
      .tab-pane.form-horizontal#profile
        - if @organization.org_type != 'Business'
          .row-fluid
            .span5
              = f.input :profile_title, input_html: { class: "input-block-level" }
              = f.input :subscribe_url, input_html: { class: "input-block-level" }
              = label_tag "Logo"
              = image_tag(@organization.logo.url) if @organization.logo?
              - if @organization.logo?
                = f.input :remove_logo, as: :boolean, label: "Remove logo?"
              = f.input :logo, label: false
              = f.input :remote_logo_url, label: "OR Upload from URL:"
            .span7
              .summernote-wrapper
                = f.input :description, as: :summernote, label: 'Description'
        - else
          - @organization.business_locations.each do |location|
            = simple_fields_for location do |g|
              .row-fluid
                .span6
                  = g.hidden_field :business_location_id, value: location.id
                  = g.input :name, input_html: { class: "input-block-level" }
                  = g.input :email, input_html: { class: "input-block-level" }
                  = g.input :venue_url, input_html: { class: "input-block-level" }
                .span6
                  = g.input :address, input_html: { class: "input-block-level" }
                  = g.input :city, input_html: { class: "input-block-level" }
                  = g.input :state, input_html: { class: "input-block-level" }
                  = g.input :zip, input_html: { class: "input-block-level" }
                  = g.input :phone, input_html: { class: "input-block-level" }
                .row-fluid
                  %h3 Opening Hours
                  %span.hint 
                    Each rule needs to be in 
                    = link_to 'Schema.org OpeningHours format.', 'https://schema.org/openingHours'
                    To specify days and time, use | as a separator. For example: Mo-Th|16:00-20:00
                  %span.pull-left.btn.btn-success.add-hours-link + Add Hours
                #business_location_hours
                  = g.fields_for :hours do |i|
                    - if location.hours.present? and location.hours.is_a?(Array)
                      - location.hours.each do |hour|
                        .row-fluid
                          .span6
                            = i.text_field nil, value: hour, class: 'span12'
                          .span2.offset4
                            .btn.btn-danger.remove-hours-field X
            = simple_fields_for location.business_profile do |h|
              = h.association :business_categories, label_method: :name_with_parent, input_html: { class: 'chosen-select input-block-level' }
      .tab-pane#business_locations
        .pull-right
          - unless @organization.org_type == "Business"
            = link_to "+ Add New Location", "#", class: "btn btn-success", data: { form_url: new_business_location_path({ organization_id: @organization.id }  )}, id: "new_business_location_button" 
          / hidden field for creating business locations associated with a new organization record
          - unless @organization.id
            = f.association :business_locations, as: :hidden, input_html: { name: "organization[business_location_list]", value: "" }
        %table.table.table-striped.table-condensed.sortable#business_locations_table
          %thead
            %tr
              %th ID
              %th Name
              %th Address
              %th Phone
              %th Email
              %th Hours
              %th
          %tbody#business_locations_list
            - @organization.business_locations.each do |loc|
              = render "business_locations/partials/row", business_location: loc

      .tab-pane#images
        = label_tag "Logo"
        = image_tag(@organization.logo.url) if @organization.logo?
        - if @organization.logo?
          = f.input :remove_logo, as: :boolean, label: "Remove logo?"
        .row-fluid
          .span1
            = f.input :logo, label: false
          .span3.form-horizontal
            = f.input :remote_logo_url, label: "OR Upload from URL:"
      .tab-pane#contacts
        .pull-right
          = link_to "+ Add New Contact", "#", class: "btn btn-success", data: { form_url: new_contact_path(Organization, @organization.id) }, id: "new_contact_button"
          / hidden field for creating contacts associated with a new organization record
          - unless @organization.id
            = f.association :contacts, as: :hidden, input_html: { name: "organization[contact_list]" , value: "" }
        %table.table.table-striped.table-condensed.sortable#contacts_table
          %thead
            %tr
              %th ID
              %th Type
              %th Name
              %th Phone
              %th Email
              %th Notes
              %th
          %tbody#contact_list
            - @organization.contacts.each do |contact|
              = render "contacts/contact_row", contact: contact
      .tab-pane#locations
        .row-fluid
          .span8
            = text_field_tag :search_locations, nil, class: "span12", placeholder: "search available locations"
          .span4
            = link_to "+ Add New Promote Location", "#", class: "btn btn-success", data: { form_url: new_location_path }, id: "new_location_button"
          .row-fluid
            .span8
              = f.association :locations, label: false, input_html: { class: "locations-select multi-select" }
          .row-fluid
            .span2.offset2.text-right
              = link_to "select all", "#", id: "select-all-locs"
            .span2.text-left
              = link_to "deselect all", "#", id: "deselect-all-locs"
      - if @organization.id
        .tab-pane#managers
          .row-fluid
            %h2 Organization Managers
            .span12
              %table.table.table-striped.table-hover.table-condensed
                %thead
                  %tr
                    %th Id
                    %th Name
                    %th Email
                    %th Remove
                %tbody
                  - if @managers.present?
                    - @managers.each do |m|
                      %tr
                        %td= m.id
                        %td= m.name
                        %td= m.email
                        %td= link_to 'remove', business_profiles_delete_manager_path(organization_id: @organization.id, user_id: m.id), method: :delete, class: 'btn btn-mini btn-warning'
                  - else
                    %tr
                      %td No managers yet
            %h3 Search Users
            .span12
              %table.table.table-striped.table-hover.data-table
                %thead
                  %tr
                    %th Id
                    %th Name
                    %th Email
                    %th Add as Manager
                %tbody
                  - @users.each do |user|
                    - unless @managers.present? and @managers.include?(user)
                      %tr  
                        %td= user.id
                        %td= user.name
                        %td= user.email
                        %td.actions
                          = link_to 'add', business_profiles_managers_path(organization_id: @organization.id, user_id: user.id), method: :post, class: 'btn btn-mini btn-warning'

        .tab-pane#issues
          .pull-right
            = link_to "+ Add New Issue", "#", class: "btn btn-success", data: { form_url: new_issue_path({organization_id: @organization.id}) }, id: "new_issue_button"
          %table.table.table-striped.table-condensed.sortable#issues_table
            %thead
              %tr
                %th ID
                %th Edition
                %th Copyright
                %th Publication Date
                %th
            %tbody#issue_list
              - @organization.issues.each do |issue|
                = render "issues/issue_row", issue: issue
        .tab-pane#history
          histry
        .tab-pane#promotions
          = render "promotions/partials/promotions_tab", organization: @organization

      .form-actions
        = submit_tag "Submit and Create New Content Set", class: "btn btn-success", name: "add_content_set"
        = submit_tag nil, class: "btn btn-primary"
        = link_to "Cancel", :back, class: "btn"

.modal.fade.modal-hack#contact_form
  .modal-header
    %button.close{ type: "button", data: { dismiss: "modal" } } x
    %h3 Organization Contact
  .modal-body
    Loading...


.modal.fade.modal-hack#issue_form
  .modal-header
    %button.close{ type: "button", data: { dismiss: "modal" } } x
    %h3 Issue
  .modal-body
    Loading...

.modal.fade.modal-hack#location_form
  .modal-header
    %button.close{ type: "button", data: { dismiss: "modal" } } x
    %h3 Location
  .modal-body
    Loading...

.modal.fade.modal-hack#business_location_form
  .modal-header
    %button.close{ type: "button", data: { dismiss: "modal" } } x
    %h3 Business Location
  .modal-body
    Loading...   
